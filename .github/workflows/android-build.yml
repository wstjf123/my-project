name: Android APK Build

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Bazel and Valdi
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
            ~/.valdi
          key: bazel-android-${{ runner.os }}-${{ hashFiles('WORKSPACE', '.bazelrc', 'BUILD.bazel', 'modules/**/BUILD.bazel') }}
          restore-keys: |
            bazel-android-${{ runner.os }}-

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Update apt cache
        run: sudo apt-get update

      - name: Install Bazelisk
        run: |
          sudo curl -L "https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64" -o /usr/local/bin/bazelisk
          sudo chmod +x /usr/local/bin/bazelisk

      - name: Install Valdi CLI
        run: npm install -g @snap/valdi

      - name: Run Valdi dev_setup
        run: valdi dev_setup

      - name: Build Android APK (release, arm64)
        run: >
          bazelisk build //:my_project_app_android
          --snap_flavor=production
          -c opt
          --copt=-DANDROID_WITH_JNI
          --repo_env=VALDI_PLATFORM_DEPENDENCIES=android
          --define client_repo_arm64=true
          --fat_apk_cpu=arm64-v8a
          --android_cpu=arm64-v8a

      - name: Find APK
        id: find_apk
        run: |
          # Bazel reports APK as bazel-bin/my_project_app_android.apk
          # bazel-bin is a symlink into Bazel's output tree, so follow symlinks.
          APK_PATH=$(find -L bazel-bin -type f -name "*.apk" -print -quit)
          if [ -z "$APK_PATH" ]; then
            echo "No APK found under bazel-bin"
            echo "bazel-bin contents:"
            ls -R bazel-bin || true
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}

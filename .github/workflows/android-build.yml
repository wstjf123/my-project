name: Android APK Build

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          # Cache Bazelisk itself so Bazel does not need
          # to be downloaded on every run.
          bazelisk-cache: true
          # Enable Bazel disk cache per workflow to speed up builds.
          disk-cache: ${{ github.workflow }}
          # Share external repository cache between workflows.
          repository-cache: true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Valdi CLI
        run: npm install -g @snap/valdi

      - name: Build Android APK (release, arm64)
        run: >
          bazel build //:my_project_app_android
          --snap_flavor=production
          -c opt
          --copt=-DANDROID_WITH_JNI
          --repo_env=VALDI_PLATFORM_DEPENDENCIES=android
          --define client_repo_arm64=true
          --fat_apk_cpu=arm64-v8a
          --android_cpu=arm64-v8a

      - name: Find APK
        id: find_apk
        run: |
          # Bazel reports APK as bazel-bin/my_project_app_android.apk
          # bazel-bin is a symlink into Bazel's output tree, so follow symlinks.
          APK_PATH=$(find -L bazel-bin -type f -name "*.apk" -print -quit)
          if [ -z "$APK_PATH" ]; then
            echo "No APK found under bazel-bin"
            echo "bazel-bin contents:"
            ls -R bazel-bin || true
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
